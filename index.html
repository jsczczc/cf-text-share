<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ–‡æœ¬ç®¡ç†</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
:root {
  --bg: #f6f7fb;
  --card: #ffffff;
  --text: #000;
}
.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e5e7eb;
}

body {
  margin: 0;
  font-family: system-ui;
  background: var(--bg);
  color: var(--text);
}
.container {
  max-width: 1000px;
  margin: 40px auto;
  background: var(--card);
  padding: 25px;
  border-radius: 14px;
}

button { padding: 8px 14px; margin: 4px; cursor: pointer; }
textarea { width: 100%; height: 220px; }

#preview {
  border: 1px dashed #aaa;
  padding: 10px;
  margin-top: 10px;
}

.hidden { display: none; }
.item { cursor: pointer; padding: 6px; }
.item:hover { background: #ddd; }
</style>
</head>

<body>

<!-- ç™»å½•é¡µ -->
<div class="container" id="loginBox">
<h2>ğŸ” ç™»å½•</h2>
<input id="pwd" type="password">
<button onclick="login()">ç™»å½•</button>
</div>

<!-- ä¸»ç³»ç»Ÿ -->
<div class="container hidden" id="app">

<h2>ğŸ“„ æ–‡æœ¬ç®¡ç†ä¸­å¿ƒ</h2>

<button onclick="toggleDark()">ğŸŒ™ é»‘æš—æ¨¡å¼</button>
<button onclick="showRecycle()">ğŸ—‘ å›æ”¶ç«™</button>

<br><br>
IDï¼š<input id="fileId"><br>
æ ‡é¢˜ï¼š<input id="title"><br>

<textarea id="content"></textarea>

<br>
<button onclick="save()">ğŸ’¾ ä¿å­˜</button>
<button onclick="remove()">âŒ åˆ é™¤</button>
<button onclick="togglePreview()">ğŸ‘ é¢„è§ˆ</button>

<div id="share"></div>
<div id="preview" class="hidden"></div>

<hr>
<h3>ğŸ“š æ–‡æ¡£åˆ—è¡¨</h3>
<div id="list"></div>

<h3 class="hidden" id="recTitle">â™» å›æ”¶ç«™</h3>
<div id="recycleList"></div>

</div>

<script>
let allDocs = [];
let currentId = '';

/* ç™»å½• */
async function login() {
  const pwd = document.getElementById('pwd').value;

  const r = await fetch('/api/login', {
    method: 'POST',
    body: JSON.stringify({ password: pwd })
  });

  if (r.ok) {
    loginBox.classList.add('hidden');
    app.classList.remove('hidden');
    loadList();
  } else {
    alert('å¯†ç é”™è¯¯');
  }
}

/* é»‘æš—æ¨¡å¼ */
function toggleDark() {
  document.body.classList.toggle('dark');
}

/* Markdown é¢„è§ˆ */
function togglePreview() {
  const box = document.getElementById('preview');
  const text = document.getElementById('content').value;
  box.innerHTML = marked.parse(text);
  box.classList.toggle('hidden');
}

/* åŠ è½½åˆ—è¡¨ */
async function loadList() {
  const res = await fetch('/api/list');
  const ids = await res.json();

  allDocs = [];
  for (const id of ids) {
    const r = await fetch('/api/load?id=' + id);
    const text = await r.text();
    const title = text.split('\n')[0];
    allDocs.push({ id, title, text });
  }

  document.getElementById('list').innerHTML =
    allDocs.map(d => `<div class="item" onclick="openDoc('${d.id}')">${d.title} (${d.id})</div>`).join('');
}

/* æ‰“å¼€ */
function openDoc(id) {
  const d = allDocs.find(x => x.id === id);
  currentId = id;

  fileId.value = id;
  const lines = d.text.split('\n');
  title.value = lines.shift();
  content.value = lines.join('\n');
}

/* ä¿å­˜ */
async function save() {
  const id = fileId.value.trim();
  const full = title.value + '\n' + content.value;

  await fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, content: full })
  });

  share.innerHTML = location.origin + '/view.html?id=' + id;
  loadList();
}

/* çœŸåˆ é™¤ + å›æ”¶ç«™ */
async function remove() {
  if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿå¯åœ¨å›æ”¶ç«™æ¢å¤')) return;

  // å­˜å…¥å›æ”¶ç«™
  await fetch('/api/save', {
    method: 'POST',
    body: JSON.stringify({
      id: 'RECYCLE_' + currentId,
      content: title.value + '\n' + content.value
    })
  });

  // çœŸåˆ é™¤
  await fetch('/api/delete', {
    method: 'POST',
    body: JSON.stringify({ id: currentId })
  });

  currentId = '';
  fileId.value = '';
  title.value = '';
  content.value = '';

  loadList();
}

/* å›æ”¶ç«™ */
async function showRecycle() {
  recTitle.classList.remove('hidden');

  const r = await fetch('/api/list');
  const ids = await r.json();

  const rec = ids.filter(x => x.startsWith('RECYCLE_'));

  recycleList.innerHTML = rec.map(id =>
    `<div onclick="restore('${id}')">â™» ${id.replace('RECYCLE_','')}</div>`
  ).join('');
}

/* æ¢å¤ */
async function restore(id) {
  const r = await fetch('/api/load?id=' + id);
  const text = await r.text();
  const realId = id.replace('RECYCLE_','');

  await fetch('/api/save', {
    method: 'POST',
    body: JSON.stringify({ id: realId, content: text })
  });

  await fetch('/api/delete', {
    method: 'POST',
    body: JSON.stringify({ id })
  });

  alert('âœ… å·²æ¢å¤');
  loadList();
}
</script>

</body>
</html>
