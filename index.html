<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ–‡æœ¬ç®¡ç†</title>
<style>
body {
  font-family: system-ui;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1000px;
  margin: 40px auto;
  background: white;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
}
h1 { text-align: center; }

.top {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}
input, textarea {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 14px;
}
textarea {
  width: 100%;
  height: 260px;
  resize: vertical;
}

button {
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  background: #4f46e5;
  color: white;
}
button:hover { opacity: .9; }

.save-btn { background: #16a34a; }
.del-btn { background: #dc2626; }
.new-btn { background: #2563eb; }

.actions {
  margin-top: 10px;
  display: flex;
  gap: 10px;
  align-items: center;
}

#share {
  font-size: 14px;
  color: #2563eb;
  word-break: break-all;
}

.list {
  margin-top: 25px;
  border-top: 1px solid #eee;
  padding-top: 15px;
}

.item {
  display: flex;
  justify-content: space-between;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
}
.item:hover { background: #f1f5f9; }

.meta { font-size: 13px; color: #666; }

.search {
  width: 100%;
  margin: 10px 0;
}
</style>
</head>

<body>
<div class="container">
<h1>ğŸ“„ æ–‡æœ¬ç®¡ç†ä¸­å¿ƒ</h1>

<!-- æœç´¢ -->
<input class="search" id="search" placeholder="ğŸ” æœç´¢ ID æˆ–æ ‡é¢˜..." oninput="renderList()">

<!-- æ–°å»º -->
<div class="top">
  <input id="fileId" placeholder="è‡ªå®šä¹‰ID">
  <button class="new-btn" onclick="newDoc()">â• æ–°å»º</button>
</div>

<!-- æ ‡é¢˜ -->
<input id="title" placeholder="è¯·è¾“å…¥æ ‡é¢˜ï¼ˆç¬¬ä¸€è¡Œæ˜¾ç¤ºä¸ºåˆ—è¡¨æ ‡é¢˜ï¼‰">

<!-- å†…å®¹ -->
<textarea id="content" placeholder="è¯·è¾“å…¥æ­£æ–‡..."></textarea>

<div class="actions">
  <button class="save-btn" onclick="save()">ğŸ’¾ ä¿å­˜</button>
  <button class="del-btn" onclick="remove()">ğŸ—‘ åˆ é™¤</button>
  <span id="share"></span>
</div>

<div class="list">
  <b>å·²æœ‰æ–‡æ¡£ï¼š</b>
  <div id="list">åŠ è½½ä¸­...</div>
</div>

</div>

<script>
let allDocs = [];
let currentId = '';

async function loadList() {
  const res = await fetch('/api/list');
  const ids = await res.json();
  allDocs = [];

  for (const id of ids) {
    const r = await fetch('/api/load?id=' + id);
    const text = await r.text();
    const title = text.split('\n')[0] || '(æ— æ ‡é¢˜)';
    allDocs.push({ id, title, text });
  }

  renderList();
}

function renderList() {
  const kw = document.getElementById('search').value.toLowerCase();
  const listDiv = document.getElementById('list');

  const filtered = allDocs.filter(d =>
    d.id.toLowerCase().includes(kw) ||
    d.title.toLowerCase().includes(kw)
  );

  if (filtered.length === 0) {
    listDiv.innerHTML = 'æš‚æ— åŒ¹é…æ–‡æ¡£';
    return;
  }

  listDiv.innerHTML = filtered.map(d =>
    `<div class="item" onclick="openDoc('${d.id}')">
      <div>
        <b>${d.title}</b>
        <div class="meta">${d.id}</div>
      </div>
    </div>`
  ).join('');
}

function openDoc(id) {
  const doc = allDocs.find(d => d.id === id);
  if (!doc) return;

  currentId = id;
  document.getElementById('fileId').value = id;

  const lines = doc.text.split('\n');
  document.getElementById('title').value = lines.shift();
  document.getElementById('content').value = lines.join('\n');

  showShare(id);
}

function newDoc() {
  currentId = '';
  document.getElementById('fileId').value = '';
  document.getElementById('title').value = '';
  document.getElementById('content').value = '';
  document.getElementById('share').innerHTML = '';
}

async function save() {
  const id = document.getElementById('fileId').value.trim();
  const title = document.getElementById('title').value.trim();
  const content = document.getElementById('content').value;

  if (!id) return alert('è¯·è¾“å…¥ ID');

  const fullText = title + '\n' + content;

  await fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, content: fullText })
  });

  showShare(id);
  await loadList();
}

async function remove() {
  if (!currentId) return alert('æœªé€‰ä¸­æ–‡æ¡£');

  if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ–‡æ¡£å—ï¼Ÿä¸å¯æ¢å¤ï¼')) return;

  await fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: currentId, content: '__DELETE__' })
  });

  await fetch('/api/load?id=' + currentId); // è§¦å‘ KV è¦†ç›–
  alert('âœ… å·²åˆ é™¤');

  newDoc();
  loadList();
}

function showShare(id) {
  const link = location.origin + '/view.html?id=' + id;
  document.getElementById('share').innerHTML =
    `åˆ†äº«é“¾æ¥ï¼š<a href="${link}" target="_blank">${link}</a>`;
}

loadList();
</script>
</body>
</html>
